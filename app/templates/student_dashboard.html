{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="dashboard-header">
  <h1>Student Dashboard</h1>
  <p>Review your latest quiz and see how close you are to unlocking the next topic.</p>
</div>

<div class="dashboard-grid">
  <div class="dashboard-card score-card">
    <h3>Recent Quiz</h3>
    {% if last_attempt %}
      <div class="score-display">
        <span class="score-value">{{ '%.1f'|format(last_attempt.score_pct or 0) }}%</span>
        <span class="score-date">{{ last_attempt.started_at[:10] if last_attempt.started_at else '' }}</span>
      </div>
      <a href="{{ url_for('reattempt') }}" class="btn">Retake Quiz</a>
    {% else %}
      <p class="muted">Take your first quiz to start tracking mastery.</p>
      <a href="{{ url_for('quiz') }}" class="btn">Start Quiz</a>
    {% endif %}
  </div>

  <div class="dashboard-card next-step-card">
    <h3>Progression Status</h3>
    {% if unlocked_next %}
      <div class="notice success">âœ… Perfect score in both topics! You can proceed.</div>
      <a class="btn primary" href="/thanks">Proceed to Next Topic</a>
    {% else %}
      <div class="notice warn">ðŸ”’ Get 100% in both topics (this recent quiz) to proceed.</div>
      {% if last_attempt %}
        <p class="muted">Retake the quiz and aim for full marks in each topic.</p>
      {% else %}
        <p class="muted">Complete a quiz attempt to unlock the next topic.</p>
      {% endif %}
    {% endif %}
  </div>
</div>

<section class="card mastery-card">
  <h3>Concept Path to Mastery</h3>
  <p class="muted">Each concept is worth 50 points. You must get 50/50 in both concepts (100/100 total) to unlock the next topic.</p>

  <div class="mastery-summary">
    <div class="mastery-line">
      <div class="mastery-line__header">
        <h4>Data Modeling &amp; DBMS Fundamentals</h4>
        <span>{{ '%.1f'|format(two_cat.fund.pct) }}% â†’ {{ '%.1f'|format(two_cat.fund.pts) }} / 50 ({{ two_cat.fund.correct }}/{{ two_cat.fund.total }})</span>
      </div>
      <div class="progress-bar">
        <span style="width: {{ two_cat.fund.pct }}%"></span>
      </div>
    </div>

    <div class="mastery-line">
      <div class="mastery-line__header">
        <h4>Normalization &amp; Dependencies</h4>
        <span>{{ '%.1f'|format(two_cat.norm.pct) }}% â†’ {{ '%.1f'|format(two_cat.norm.pts) }} / 50 ({{ two_cat.norm.correct }}/{{ two_cat.norm.total }})</span>
      </div>
      <div class="progress-bar">
        <span style="width: {{ two_cat.norm.pct }}%"></span>
      </div>
    </div>
  </div>

  <div class="mastery-overall">
    <strong>Overall:</strong> {{ '%.1f'|format(two_cat.overall_points) }} / 100
  </div>
</section>

<section class="card" style="padding:1rem;">
  <h3>Learning Modules</h3>
  <div class="module-links">
    <a class="btn" href="/module/fundamentals">Data Modeling &amp; DBMS Fundamentals</a>
    <a class="btn" href="/module/norm">Normalization &amp; Dependencies</a>
  </div>
</section>

<div class="progress-section">
  <h2>Progress Over Time</h2>
  <div class="chart-container">
    <canvas id="scoreChart" width="400" height="200"></canvas>
  </div>
</div>

<script>
  const labels = {{ labels|tojson }};
  const scores = {{ scores|tojson }};
  const ctx = document.getElementById('scoreChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Score %',
        data: scores,
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79, 70, 229, 0.12)',
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
</script>
{% endblock %}
