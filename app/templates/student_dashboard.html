{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="dashboard-header">
  <h1>Student Dashboard</h1>
  <p>Track your progress and master database normalization concepts.</p>
</div>

<div class="dashboard-grid">
  <!-- Recent Score Card -->
  <div class="dashboard-card score-card">
    <h3>Recent Score</h3>
    {% if last_attempt %}
      <div class="score-display">
        <span class="score-value">{{ '%.0f'|format(last_attempt.score_pct) if last_attempt and last_attempt.score_pct else 0 }}%</span>
        <span class="score-date">{{ last_attempt.started_at[:10] if last_attempt and last_attempt.started_at else '' }}</span>
      </div>
      <a href="{{ url_for('reattempt') }}" class="btn btn-primary">Reattempt Quiz</a>
    {% else %}
      <div class="score-display">
        <span class="score-value">--</span>
        <span class="score-date">No attempts yet</span>
      </div>
      <a href="{{ url_for('quiz') }}" class="btn btn-primary">Take Quiz</a>
    {% endif %}
  </div>

  <!-- Next Step Card -->
  <div class="dashboard-card next-step-card">
    <h3>Next Recommendation</h3>
    {% if two_cat.unlocked_next %}
      <div class="next-step-content success">
        <h4>Recommendation Unlocked</h4>
        <p>Perfect 50/50 in both concepts! You're ready for the advanced recommendation.</p>
        <a href="{{ url_for('modules') }}" class="btn btn-secondary">Explore Modules</a>
      </div>
    {% elif next_step %}
      <div class="next-step-content">
        <h4>Focus on {{ next_step }}</h4>
        <p>Score 50/50 here to unlock the next recommendation.</p>
        <div class="progress-gauge">
          <span class="gauge-value">{{ '%.0f'|format(next_step_accuracy) }}%</span>
          <div class="gauge-bar">
            <div class="gauge-fill" style="width: {{ next_step_accuracy }}%"></div>
          </div>
        </div>
        {% if focus_module_url %}
          <a href="{{ focus_module_url }}" class="btn btn-secondary">Review Module</a>
        {% else %}
          <a href="{{ url_for('modules') }}" class="btn btn-secondary">Review Modules</a>
        {% endif %}
      </div>
    {% else %}
      <div class="next-step-content">
        <p class="mastered-message">Take your first quiz attempt to see personalized recommendations.</p>
        <a href="{{ url_for('quiz') }}" class="btn btn-secondary">Start Quiz</a>
      </div>
    {% endif %}
  </div>
</div>

<section class="card mastery-overview-card">
  <h3>Concept Path to Mastery</h3>
  <p class="muted">Each concept is worth 50 points. Score full marks in both to unlock the next recommendation.</p>

  <div class="mastery-grid">
    {% for step in mastery_steps %}
      <div class="mastery-track">
        <div class="mastery-step">
          <span class="step-label">Attempt</span>
          <p class="step-value">{{ step.attempts }} {{ 'attempt' if step.attempts == 1 else 'attempts' }}</p>
        </div>
        <div class="mastery-step">
          <span class="step-label">Score Full Marks</span>
          <div class="progress-track">
            <div class="progress-fill" style="width: {{ step.points_pct }}%"></div>
          </div>
          <p class="step-value">{{ '%.1f'|format(step.points) }}/50 pts Â· {{ '%.1f'|format(step.accuracy) }}% accuracy</p>
        </div>
        <div class="mastery-step {{ 'status-success' if step.full_marks else 'status-pending' }}">
          <span class="step-label">Excelled Mastery</span>
          <p class="step-value">{{ step.mastery_text }}</p>
        </div>
        <div class="mastery-step recommendation-step">
          <span class="step-label">Recommendation</span>
          <p class="step-value">{{ step.recommendation }}</p>
          {% if not step.full_marks %}
            <a class="inline-link" href="{{ step.module_url }}">Review module</a>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="overall-status">
    <p><strong>Overall Progress:</strong> {{ two_cat.overall_points }}/100 points</p>
    {% if two_cat.unlocked_next %}
      <p class="muted">âœ… Recommendation unlocked â€“ continue to the next topic.</p>
      <a class="btn" href="/thanks">Finish Prototype</a>
    {% else %}
      <p class="muted">ðŸ”’ Earn 50/50 in both concepts (100/100 total) to unlock the recommendation.</p>
    {% endif %}
  </div>
</section>

<section class="card" style="padding:1rem;">
  <h3>Learning Modules</h3>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem;">
      <a class="btn" href="/module/fundamentals">Data Modeling & DBMS Fundamentals</a>
      <a class="btn" href="/module/norm">Normalization & Dependencies</a>
  </div>
</section>

<!-- Progress Chart -->
<div class="progress-section">
  <h2>Progress Over Time</h2>
  <div class="chart-container">
    <canvas id="scoreChart" width="400" height="200"></canvas>
  </div>
</div>

<script>
  const labels = {{ labels|tojson }};
  const scores = {{ scores|tojson }};
  const ctx = document.getElementById('scoreChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: { 
      labels, 
      datasets: [{ 
        label: 'Score %', 
        data: scores, 
        borderColor: '#1e88e5',
        backgroundColor: 'rgba(30, 136, 229, 0.1)',
        fill: true
      }] 
    },
    options: { 
      responsive: true,
      scales: { 
        y: { 
          beginAtZero: true, 
          max: 100 
        } 
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
</script>
{% endblock %}