{% extends 'base.html' %}
{% block title %}Thanks{% endblock %}
{% block content %}
<h2>Give a Rating</h2>
<p><strong>Loving the experience? Let’s take a moment to appreciate the creator & his AI tools. If not, give one star.</strong></p>

<div id="rating-box" class="card" style="padding:1rem;max-width:480px;">
  <div id="stars" style="font-size:28px;cursor:pointer;">
    <span data-val="1">☆</span>
    <span data-val="2">☆</span>
    <span data-val="3">☆</span>
    <span data-val="4">☆</span>
    <span data-val="5">☆</span>
  </div>
  <textarea id="comment" rows="3" style="width:100%;margin-top:.5rem;" placeholder="Optional comment..."></textarea>
  <button id="submitRating" class="btn" style="margin-top:.5rem;">Submit</button>
  <p id="statusMsg" class="muted" style="margin-top:.5rem;"></p>
</div>

<script>
let picked = 0;
const stars = document.querySelectorAll('#stars span');
const attemptId = {{ session.get('last_attempt_id', 0) or 0 }};

function paintStars(target) {
  const v = parseInt(target.dataset.val || '0');
  stars.forEach(x => {
    x.textContent = parseInt(x.dataset.val) <= v ? '★' : '☆';
  });
}

stars.forEach(s => {
  s.addEventListener('mouseover', () => paintStars(s));
  s.addEventListener('focus', () => paintStars(s));
  s.addEventListener('click', () => {
    picked = parseInt(s.dataset.val || '0');
    paintStars(s);
  });
});

async function submitFeedback(){
  const status = document.getElementById('statusMsg');
  const comment = document.getElementById('comment').value || '';
  if (!picked) {
    status.textContent = 'Please pick 1-5 stars.';
    return;
  }
  try {
    const res = await fetch('/api/feedback', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ rating: picked, comment })
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data.ok) {
      if (attemptId) {
        window.location = `/review/${attemptId}?feedback=1`;
      } else {
        window.location = `/student/{{ session.student_id }}?feedback=1`;
      }
    } else {
      status.textContent = (data && data.error) ? data.error : 'Failed to submit feedback.';
    }
  } catch (err) {
    status.textContent = 'Unable to submit feedback right now.';
  }
}

document.getElementById('submitRating').addEventListener('click', submitFeedback);
</script>
{% endblock %}



